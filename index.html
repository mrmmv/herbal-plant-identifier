<!DOCTYPE html>
<html>
<head>
    <title>Herbal Plant Identifier</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
    <h1>Herbal Plant Identifier</h1>
    <script type="text/javascript">
        let model;
        const confidenceThreshold = 0.6;  // Set a threshold for herbal plant detection

        // Load the TensorFlow.js model
        async function loadModel() {
            model = await tf.loadLayersModel('https://mrmmv.github.io/herbal-plant-identifier/model.json');
            console.log("Model loaded");
        }

        // Convert an image from URL to a Tensor that can be processed by the model
        async function imageToTensor(imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";  // This allows the image to be loaded from external sources
                img.src = imageUrl;
                img.onload = () => {
                    // Convert the image to a tensor
                    const tensor = tf.browser.fromPixels(img)
                        .resizeNearestNeighbor([224, 224])  // Adjust to your model's input size
                        .toFloat()
                        .expandDims();
                    resolve(tensor);
                };
            });
        }

        // Process the image and make a prediction
        async function predictImage(imageUrl) {
            const tensor = await imageToTensor(imageUrl);

            // Get predictions from the model
            const predictions = await model.predict(tensor).data();

            // Find the highest prediction probability and its corresponding class
            let maxPrediction = Math.max(...predictions);
            let predictedClassIndex = predictions.indexOf(maxPrediction);

            // If the highest prediction is below the threshold, consider it not a herbal plant
            if (maxPrediction < confidenceThreshold) {
                return "Not a herbal plant";
            }

            // Map the predicted index to class names (labels)
            const classLabels = ["Hibiscus rosa-sinensis(Gumamela)", "Psidium guajava(Bayabas)", "Antidesma bunius(Bignay)", "Vitex negundo(Lagundi)", "Moringa oleifera(Malunggay)", "Blumea balsamifera(Sambong)", "Origanum vulgare(Oregano)", "Pepromia pellucida(Ulasimang-bato)", "Centella asiatica(Takip-Kohol)", "Coleus scuttelarioedes (Mayana)", "Phyllanthus niruri(Sampa-sampalukan)", "Corchorus olitorius(Saluyot)", "Momordica charantia (Marigoso)", "Euphorbia hirta(Tawa-tawa)", "Curcuma longa(Turmeric)", "Carmona retusa(Tsaang-Gubat)", "Senna alata(Akapulko)", "Mentha cordifolia Opiz(Mint)", "Capsicum frutescens(Siling labuyo)", "Jatropha curcas(Tubang-bakod)", "Ocimum basilicum(Basil)", "Nerium oleander(South Sea Rose)", "Pandanus amaryllifolius(Pandan)", "Aloe barbadensis Miller(Alovera)", "Lagerstroemia speciosa(Banaba)", "Averrhoea bilimbi(Kamias)","Annona muricata(Guyabano)","Citrus aurantiifolia(Lime)","Premna odorata(Alagaw)","Gliricidia sepium(Kawate)","Citrus sinensis(Orange)","Mangifera indica(Mangga)","Citrus microcarpa(Calamansi)","Impatiens balsamina(Kamantague)","Arachis hypogaea(Peanut)","Tamarindus indica(Tamarind)","Leucaena leucocephala(Ipil-Ipil)","Ipomoea batatas(Kamote)","Manihot esculenta(Cassava)","Citrus maxima(Pomelo)"];  // Replace with your actual class names
            return classLabels[predictedClassIndex];
        }

        // Listen for messages from the MIT App Inventor app
        window.addEventListener('message', async (event) => {
            const imageUrl = event.data;  // The image URL sent from the app
            const prediction = await predictImage(imageUrl);
            console.log(prediction);
            // Send the prediction result back to MIT App Inventor
            window.ReactNativeWebView.postMessage(prediction);
        });

        loadModel();
    </script>
</body>
</html>
