<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbal Plant Identifier</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
    <h1>Herbal Plant Identifier</h1>
    <script type="text/javascript">
        let model;
        const confidenceThreshold = 0.6;  // Set a threshold for herbal plant detection

        // Load the TensorFlow.js model
        async function loadModel() {
            try {
                model = await tf.loadLayersModel('https://mrmmv.github.io/herbal-plant-identifier/model.json');
                console.log("Model loaded successfully");
            } catch (error) {
                console.error("Error loading model:", error);
            }
        }

        // Convert an image from URL to a Tensor that can be processed by the model
        async function imageToTensor(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";  // This allows the image to be loaded from external sources
                img.src = imageUrl;
                img.onload = () => {
                    try {
                        // Convert the image to a tensor
                        const tensor = tf.browser.fromPixels(img)
                            .resizeNearestNeighbor([224, 224])  // Adjust to your model's input size
                            .toFloat()
                            .expandDims();
                        resolve(tensor);
                    } catch (error) {
                        console.error("Error converting image to tensor:", error);
                        reject(error);
                    }
                };
                img.onerror = (error) => {
                    console.error("Error loading image:", error);
                    reject(error);
                };
            });
        }

        // Process the image and make a prediction
        async function predictImage(imageUrl) {
            try {
                const tensor = await imageToTensor(imageUrl);

                // Get predictions from the model
                const predictions = await model.predict(tensor).data();

                // Convert predictions to an array
                const predictionsArray = Array.from(predictions);

                console.log("Predictions array:", predictionsArray);

                // Find the highest prediction probability and its corresponding class
                const maxPrediction = Math.max(...predictionsArray);
                const predictedClassIndex = predictionsArray.indexOf(maxPrediction);

                console.log("Max prediction value:", maxPrediction);
                console.log("Predicted class index:", predictedClassIndex);

                // If the highest prediction is below the threshold, consider it not a herbal plant
                if (maxPrediction < confidenceThreshold) {
                    return "Not a herbal plant";
                }

                // Map the predicted index to class names (labels)
                const classLabels = [
                    "Hibiscus rosa-sinensis (Gumamela)", "Psidium guajava (Bayabas)", "Antidesma bunius (Bignay)",
                    "Vitex negundo (Lagundi)", "Moringa oleifera (Malunggay)", "Blumea balsamifera (Sambong)",
                    "Origanum vulgare (Oregano)", "Peperomia pellucida (Ulasimang-bato)", "Centella asiatica (Takip-Kohol)",
                    "Coleus scutellarioides (Mayana)", "Phyllanthus niruri (Sampa-sampalukan)", "Corchorus olitorius (Saluyot)",
                    "Momordica charantia (Marigoso)", "Euphorbia hirta (Tawa-tawa)", "Curcuma longa (Turmeric)",
                    "Carmona retusa (Tsaang-Gubat)", "Senna alata (Akapulko)", "Mentha cordifolia Opiz (Mint)",
                    "Capsicum frutescens (Siling labuyo)", "Jatropha curcas (Tubang-bakod)", "Ocimum basilicum (Basil)",
                    "Nerium oleander (South Sea Rose)", "Pandanus amaryllifolius (Pandan)", "Aloe barbadensis Miller (Aloe Vera)",
                    "Lagerstroemia speciosa (Banaba)", "Averrhoa bilimbi (Kamias)", "Annona muricata (Guyabano)",
                    "Citrus aurantiifolia (Lime)", "Premna odorata (Alagaw)", "Gliricidia sepium (Kakawate)",
                    "Citrus sinensis (Orange)", "Mangifera indica (Mangga)", "Citrus microcarpa (Calamansi)",
                    "Impatiens balsamina (Kamantigue)", "Arachis hypogaea (Peanut)", "Tamarindus indica (Tamarind)",
                    "Leucaena leucocephala (Ipil-Ipil)", "Ipomoea batatas (Kamote)", "Manihot esculenta (Cassava)",
                    "Citrus maxima (Pomelo)"
                ];

                if (predictedClassIndex >= 0) {
                    return classLabels[predictedClassIndex];
                } else {
                    return "Prediction error: No valid class index found";
                }

            } catch (error) {
                console.error("Error predicting image:", error);
                return "Error in prediction";
            }
        }

        // Listen for messages from the MIT App Inventor app
        window.addEventListener('message', async (event) => {
            try {
                const imageUrl = event.data;  // The image URL sent from the app
                console.log("Received image URL:", imageUrl);

                if (imageUrl) {
                    const prediction = await predictImage(imageUrl);
                    console.log("Prediction result:", prediction);

                    // Send the prediction result back to MIT App Inventor or React Native WebView
                    if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
                        window.ReactNativeWebView.postMessage(`"${prediction}"`);
                    } else {
                        window.postMessage(`"${prediction}"`, '*');
                    }
                } else {
                    console.error("Invalid image URL received:", imageUrl);
                }
            } catch (error) {
                console.error("Error handling message:", error);
            }
        });

        // Load the model when the page loads
        window.onload = loadModel;
    </script>
</body>
</html>
